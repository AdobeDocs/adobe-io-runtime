"use strict";(self.webpackChunkadobe_io_runtime=self.webpackChunkadobe_io_runtime||[]).push([[5610],{77493:function(e,t,n){n.r(t),n.d(t,{_frontmatter:function(){return l},default:function(){return m}});var a=n(87462),o=n(63366),i=(n(15007),n(64983)),r=n(91515),d=["components"],l={},s={_frontmatter:l},p=r.Z;function m(e){var t=e.components,n=(0,o.Z)(e,d);return(0,i.mdx)(p,(0,a.Z)({},s,n,{components:t,mdxType:"MDXLayout"}),(0,i.mdx)("h1",{id:"creating-rest-apis"},"Creating REST APIs"),(0,i.mdx)("p",null,"You can create REST APIs from web actions you","’","ve deployed to Adobe I/O Runtime. Let","’","s assume that you","’","ve created four actions to manage CRUD operations for the ",(0,i.mdx)("inlineCode",{parentName:"p"},"pet")," entity:"),(0,i.mdx)("table",null,(0,i.mdx)("thead",{parentName:"table"},(0,i.mdx)("tr",{parentName:"thead"},(0,i.mdx)("th",{parentName:"tr",align:null},"CRUD Operation"),(0,i.mdx)("th",{parentName:"tr",align:null},"Action Name"))),(0,i.mdx)("tbody",{parentName:"table"},(0,i.mdx)("tr",{parentName:"tbody"},(0,i.mdx)("td",{parentName:"tr",align:null},"Create"),(0,i.mdx)("td",{parentName:"tr",align:null},(0,i.mdx)("inlineCode",{parentName:"td"},"addPet"))),(0,i.mdx)("tr",{parentName:"tbody"},(0,i.mdx)("td",{parentName:"tr",align:null},"Read"),(0,i.mdx)("td",{parentName:"tr",align:null},(0,i.mdx)("inlineCode",{parentName:"td"},"getPet"))),(0,i.mdx)("tr",{parentName:"tbody"},(0,i.mdx)("td",{parentName:"tr",align:null},"Update"),(0,i.mdx)("td",{parentName:"tr",align:null},(0,i.mdx)("inlineCode",{parentName:"td"},"updatePet"))),(0,i.mdx)("tr",{parentName:"tbody"},(0,i.mdx)("td",{parentName:"tr",align:null},"Delete"),(0,i.mdx)("td",{parentName:"tr",align:null},(0,i.mdx)("inlineCode",{parentName:"td"},"deletePet"))))),(0,i.mdx)("p",null,"You can map these actions to a REST API for managing ",(0,i.mdx)("inlineCode",{parentName:"p"},"pet")," resources:"),(0,i.mdx)("table",null,(0,i.mdx)("thead",{parentName:"table"},(0,i.mdx)("tr",{parentName:"thead"},(0,i.mdx)("th",{parentName:"tr",align:null},"Endpoint"),(0,i.mdx)("th",{parentName:"tr",align:null},"HTTP Method"),(0,i.mdx)("th",{parentName:"tr",align:null},"Action Nam"))),(0,i.mdx)("tbody",{parentName:"table"},(0,i.mdx)("tr",{parentName:"tbody"},(0,i.mdx)("td",{parentName:"tr",align:null},"/pet"),(0,i.mdx)("td",{parentName:"tr",align:null},"POST"),(0,i.mdx)("td",{parentName:"tr",align:null},(0,i.mdx)("inlineCode",{parentName:"td"},"addPet"))),(0,i.mdx)("tr",{parentName:"tbody"},(0,i.mdx)("td",{parentName:"tr",align:null},"/pet"),(0,i.mdx)("td",{parentName:"tr",align:null},"GET"),(0,i.mdx)("td",{parentName:"tr",align:null},(0,i.mdx)("inlineCode",{parentName:"td"},"getPet"))),(0,i.mdx)("tr",{parentName:"tbody"},(0,i.mdx)("td",{parentName:"tr",align:null},"/pet/{id}"),(0,i.mdx)("td",{parentName:"tr",align:null},"GET"),(0,i.mdx)("td",{parentName:"tr",align:null},(0,i.mdx)("inlineCode",{parentName:"td"},"getPet"))),(0,i.mdx)("tr",{parentName:"tbody"},(0,i.mdx)("td",{parentName:"tr",align:null},"/pet/{id}"),(0,i.mdx)("td",{parentName:"tr",align:null},"PUT"),(0,i.mdx)("td",{parentName:"tr",align:null},(0,i.mdx)("inlineCode",{parentName:"td"},"updatePet"))),(0,i.mdx)("tr",{parentName:"tbody"},(0,i.mdx)("td",{parentName:"tr",align:null},"/pet/{id}"),(0,i.mdx)("td",{parentName:"tr",align:null},"DELETE"),(0,i.mdx)("td",{parentName:"tr",align:null},(0,i.mdx)("inlineCode",{parentName:"td"},"deletePet"))))),(0,i.mdx)("p",null,"Let","’","s see how you can create this API, assuming you have the web actions are already deployed/created."),(0,i.mdx)("h1",{id:"how-long-does-it-take-to-createupdate-an-api"},"How long does it take to create/update an API"),(0,i.mdx)("p",null,"When creating or updating a REST API, it can take up to 5 minutes to see the changes. "),(0,i.mdx)("h2",{id:"using-wsk-cli"},"Using wsk CLI"),(0,i.mdx)("p",null,"Using the ",(0,i.mdx)("inlineCode",{parentName:"p"},"aio rt:api:create")," command, you create each API endpoint one-by-one. This command allows you to set a base path, path, method, and response type. We will set:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"aio rt:api:create /pet-store /pet post createPet --response-type http\naio rt:api:create /pet-store /pet get getPet --response-type http\naio rt:api:create /pet-store /pet/{id} get getPet --response-type http\naio rt:api:create /pet-store /pet/{id} put updatePet --response-type http\naio rt:api:create /pet-store /pet/{id} delete deletePet --response-type http\n")),(0,i.mdx)("p",null,"You can quickly see the API you","’","ve defined, including the fully qualified path, by running this command:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"aio rt:api:list /pet-store\n")),(0,i.mdx)("p",null,"Please note, that at this time ",(0,i.mdx)("inlineCode",{parentName:"p"},"aio rt:api:list")," is not implemented. Instead, you have to use ",(0,i.mdx)("inlineCode",{parentName:"p"},"aio rt:api:list/enter-base-path"),"."),(0,i.mdx)("p",null,"Here is an example of calling one of the endpoints:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"curl https://adobeioruntime.net:443/apis/<YOUR-NAMESPACE>/pet-store/pet/2345 -X get\n")),(0,i.mdx)("p",null,"or"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"curl https://<YOUR-NAMESPACE>.adobeioruntime.net:443/apis/pet-store/pet/2345 -X GET\n")),(0,i.mdx)("p",null,(0,i.mdx)("strong",{parentName:"p"},"Note")," the change in the URL here in comparison to what the ",(0,i.mdx)("inlineCode",{parentName:"p"},"aio")," returns. This is due some additional protections Runtime provides to segregate namespaces from each other when invoking web actions. The ",(0,i.mdx)("inlineCode",{parentName:"p"},"aio")," generated link will still work but it will return a 308 redirect to your namespace's subdomain on Runtime. For a further discussion of this please see the ",(0,i.mdx)("a",{parentName:"p",href:"securing_web_actions.md"},"Securing Web Actions")," page."),(0,i.mdx)("p",null,"In the example above, the ",(0,i.mdx)("inlineCode",{parentName:"p"},"{di}")," value, 2335, will be mapped to a {payload.id}."),(0,i.mdx)("h2",{id:"using-swagger-files"},"Using Swagger files"),(0,i.mdx)("p",null,"A neat feature when working with REST APIs is the support for Swagger files. This works for creating a new REST API from scratch or, if you already used the ",(0,i.mdx)("inlineCode",{parentName:"p"},"aio")," CLI to create one,  saving the API as a Swagger definition file that you can use later on to restore the API."),(0,i.mdx)("p",null,"Continuing the example above, if you run this command, you","’","ll create a Swagger definition file on your machine out of the pet-store API:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"aio rt:api:get /pet-store > pet-store-swagger.json\n")),(0,i.mdx)("p",null,"Suppose that you want to restore or create the same API, maybe in some other namespace. All you have to is to run:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"aio rt:api:create --config-file pet-store-swagger.json\n")),(0,i.mdx)("p",null,"This will work as long as the actions are already created in that namespace."),(0,i.mdx)("h2",{id:"enable-cors-on-an-http-resource"},"Enable CORS on an HTTP Resource"),(0,i.mdx)("p",null,(0,i.mdx)("a",{parentName:"p",href:"https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS"},"CORS")," headers can be controlled in two ways: statically, or dynamically."),(0,i.mdx)("h3",{id:"static-cors-response-with-openapi"},"Static CORS Response with OpenAPI"),(0,i.mdx)("p",null,"If the returned CORS headers can be static, no code is necessary. The REST APIs can be configured in OpenAPI 2.0 format, by defining the ",(0,i.mdx)("inlineCode",{parentName:"p"},"options")," method. The following snippet illustrates how to configure CORS headers:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-json"},'"paths": {\n    "/test": {\n      "options": {\n        "responses": {\n          "204": {\n            "description": "Default CORS response",\n            "headers": {\n              "Access-Control-Allow-Origin": {\n                "type": "string",\n                "description": "Which origin can invoke the /test API\\n",\n                "default": "https://xyz.example.com"\n              },\n              "Access-Control-Allow-Methods": {\n                "type": "string",\n                "description": "Which methods are allowed\\n",\n                "default": "GET, POST, PUT"\n              }\n            }\n          }\n        }\n      }\n    }\n}\n')),(0,i.mdx)("p",null,"Once the ",(0,i.mdx)("inlineCode",{parentName:"p"},"options")," block is added to any HTTP resource, the system will respond with the configured headers, and their corresponding ",(0,i.mdx)("inlineCode",{parentName:"p"},"default")," values. In this example the response will be:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"}," HTTP/1.1 204 No Content\n Access-Control-Allow-Methods: GET, POST, PUT\n Access-Control-Allow-Origin: https://xyz.example.com\n\n")),(0,i.mdx)("h4",{id:"dynamic-cors-response-with-custom-actions"},"Dynamic CORS Response with Custom Actions"),(0,i.mdx)("p",null,"The CORS headers can also be returned by a dedicated function, which must be configured to handle the ",(0,i.mdx)("inlineCode",{parentName:"p"},"options")," HTTP Method. It works in the same fashion as the other HTTP Methods like ",(0,i.mdx)("inlineCode",{parentName:"p"},"GET"),", or ",(0,i.mdx)("inlineCode",{parentName:"p"},"POST"),"."),(0,i.mdx)("p",null,"The code bellow demonstrates an action that returns a CORS response:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-javascript"},'// save it as cors-action.js\nfunction main(params) {\n  return {\n    statusCode: 204,\n    headers: {\n      "Access-Control-Allow-Origin": "https://xyz.example.com",\n      "Access-Control-Allow-Methods": "GET, POST, PUT"\n    }\n  }\n}\n')),(0,i.mdx)("p",null,"The web action must be created and configured for the CORS request:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-bash"},"aio rt:action:create handleCorsRequest ./cors-action.js --web true -a web-custom-options true\n\naio rt:api:create /pet-store /pet options handleCorsRequest --response-type http\n")),(0,i.mdx)("p",null,"To test the CORS request get the URL of the action, and invoke it:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-bash"},"aio rt:api:list /pet-store\n# get the URL for the options action and invoke it\ncurl -i -X OPTIONS https://adobeioruntime.net/...\n# it should return\n HTTP/1.1 204 No Content\n Access-Control-Allow-Methods: GET, POST, PUT\n Access-Control-Allow-Origin: https://xyz.example.com\n")),(0,i.mdx)("h2",{id:"securing-the-api-endpoints"},"Securing the API endpoints"),(0,i.mdx)("h3",{id:"oauth-using-the-adobe-identity-management-system"},"Oauth (using the Adobe Identity Management System)"),(0,i.mdx)("p",null,"An action can be configured to require IMS validation for incoming requests using the following command: "),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-bash"},"aio rt:action:create <action_name> --web true -a require-gw-validation true\n")),(0,i.mdx)("h4",{id:"scopes-validation"},"Scopes validation"),(0,i.mdx)("p",null,"Once IMS authentication has been enabled for an action, the only way to allow access to the action is by specifying a list of IMS scopes or client IDs that are permitted to invoke the action. "),(0,i.mdx)("p",null,"The following code snippet demonstrates how to configure access using a standard Swagger file and the ",(0,i.mdx)("inlineCode",{parentName:"p"},"security")," object:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-json"},'{\n    "basePath": "/v2",\n    "paths": {\n      "/ims-secure-endpoint": {\n        "get": {\n          "operationId": "your-namespaces/default/my-ims-secure-web-action.json",        \n          "security": [\n            {\n              "scopes_auth": [\n                  "write:pets",\n                  "read:pets"\n                ]\n            }\n          ]\n        }\n      }\n    },\n    "securityDefinitions": {\n        "scopes_auth": {\n          "type": "oauth2",\n          "authorizationUrl": "",\n          "flow": "implicit",\n          "scopes": {\n            "write:pets": "modify pets in your account",\n            "read:pets": "read your pets"\n          }\n        }\n    }\n}\n')),(0,i.mdx)("p",null,"This enables scope validation for the API endpoint, allowing requests with access tokens that have the scopes ",(0,i.mdx)("inlineCode",{parentName:"p"},"write:pets")," OR ",(0,i.mdx)("inlineCode",{parentName:"p"},"read:pets"),". Requests that do not have the required scopes in the access token will be rejected with the following error message: "),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-json"},'{\n  "error_code":"401015",\n  "message":"Scope mismatch"\n}\n')),(0,i.mdx)("p",null,"After publishing the Swagger file, this endpoint ",(0,i.mdx)("inlineCode",{parentName:"p"},"your-namespaces/default/my-require-gw-validation-web-action")," can be used to call the action: "),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-bash"},'curl -i -H "Authorization: Bearer <ims_access_token>" https://guest.adobeioruntime.net/api/v2/ims-validation-endpoint\n')),(0,i.mdx)("h4",{id:"client-id-validation"},"Client ID validation"),(0,i.mdx)("p",null,(0,i.mdx)("inlineCode",{parentName:"p"},"client_id")," validation can be enabled by adding ",(0,i.mdx)("inlineCode",{parentName:"p"},"x-client-ids")," with a list of clients that are allowed to invoke the action. The clientId list has to be added to the ",(0,i.mdx)("inlineCode",{parentName:"p"},"security definition")," object in the Swagger. Also make sure to add the security definition key to the method ",(0,i.mdx)("inlineCode",{parentName:"p"},"security")," object, otherwise the validation won't be enabled for that method: "),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-json"},'{\n    "basePath": "/v2",\n    "paths": {\n      "/ims-validation-endpoint": {\n        "get": {\n          "operationId": "your-namespaces/default/my-require-gw-validation-web-action.json",\n          "security": [\n            {\n              "clientids_auth": []\n            }\n          ]\n        }\n      }\n    },\n    "securityDefinitions": {\n        "clientids_auth": {\n          "type": "oauth2",\n          "authorizationUrl": "",\n          "flow": "implicit",\n          "scopes": {\n            "write:pets": "modify pets in your account",\n            "read:pets": "read your pets"\n          },\n          "x-client-ids": ["zookeeper", "dogwalker"]\n        }\n    }\n}\n')),(0,i.mdx)("p",null,"This configuration allows the action to accept requests with access tokens that have the client IDs ",(0,i.mdx)("inlineCode",{parentName:"p"},"zookeeper")," OR ",(0,i.mdx)("inlineCode",{parentName:"p"},"dogwalker"),". Requests that do not have the client ID in the access token will be rejected with the following error message: "),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-json"},'{\n  "error_code":"403201",\n  "message":"Client ID not allowed to call this service"\n}\n')),(0,i.mdx)("blockquote",null,(0,i.mdx)("p",{parentName:"blockquote"},"Note that both ",(0,i.mdx)("inlineCode",{parentName:"p"},"scope")," and ",(0,i.mdx)("inlineCode",{parentName:"p"},"client_id")," validation can be enabled at the same time. In this case, the request will be rejected if the access token does not have the required scope AND client ID."),(0,i.mdx)("p",{parentName:"blockquote"},"In case no validation is enabled for the endpoint's verb, by removing the ",(0,i.mdx)("inlineCode",{parentName:"p"},"security")," object from the method definition, the action can be invoked publicly without any restrictions on the API url."),(0,i.mdx)("p",{parentName:"blockquote"},'By default, the IMS token validation URL will be used for token validation so "authorizationUrl" can be left empty. However, if you want to use a different Oauth provider, you can specify the ',(0,i.mdx)("inlineCode",{parentName:"p"},"authorizationUrl")," in the ",(0,i.mdx)("inlineCode",{parentName:"p"},"securityDefinition")," object. Only one external security provider can be configured, and it needs to be defined in the first ",(0,i.mdx)("inlineCode",{parentName:"p"},"securityDefinition")," object in the Swagger file."),(0,i.mdx)("p",{parentName:"blockquote"},"Please allow a 5minute window for the changes to take effect.")),(0,i.mdx)("h3",{id:"basic-authentication"},"Basic Authentication"),(0,i.mdx)("p",null,"You secure an API the same way you","’","d do it for web actions. You can read more about this on the ",(0,i.mdx)("a",{parentName:"p",href:"securing_web_actions.md"},"Securing Web Actions")," page."),(0,i.mdx)("p",null,"Once you","’","ve enabled basic authentication for an action, you","’","d have to pass the ",(0,i.mdx)("inlineCode",{parentName:"p"},"X-Require-Whisk-Auth")," header and the secret you chose when making an API call."),(0,i.mdx)("h3",{id:"ip-allow-list--disallow-list"},"IP Allow-list / Disallow-list"),(0,i.mdx)("p",null,"Endpoints can also be configured to only allow/block requests from specific IP addresses. This can be done by adding the ",(0,i.mdx)("inlineCode",{parentName:"p"},"x-ip-allowlist")," or ",(0,i.mdx)("inlineCode",{parentName:"p"},"x-ip-disallowlist")," to the method definition as follows:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-json"},'{\n    "basePath": "/v2",\n    "paths": {\n      "/ip-validation-endpoint": {\n        "get": {\n          "operationId": "your-namespaces/default/my-require-gw-validation-web-action.json",\n          "x-ip-allowlist": ["192.150.10.210", "192.168.0.1"],\n          "x-ip-disallowlist": ["192.150.10.10"]\n        }\n      }\n    }\n}\n')),(0,i.mdx)("p",null,'This configuration allows the action to accept requests from clients with the IP addresses "192.150.10.210" or "192.168.0.1", and block requests from "192.150.10.10". '),(0,i.mdx)("p",null,"Requests that do not have the requests originating from the IP addresses in the whitelist will be rejected with the following error message:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-json"},'{\n  "error_code":"403013",\n  "message":"Access from your IP address is not authorized"\n}\n')),(0,i.mdx)("p",null,"Requests that have the requests originating from the IP addresses in the disallow list, will be rejected with the following error message:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-json"},'{\n  "error_code":"403012",\n  "message":"Access from your IP address is not authorized"\n}\n')),(0,i.mdx)("blockquote",null,(0,i.mdx)("p",{parentName:"blockquote"},"Make sure that the ",(0,i.mdx)("inlineCode",{parentName:"p"},"my-require-gw-validation-web-action")," is configured to be a web action with ",(0,i.mdx)("inlineCode",{parentName:"p"},"-a require-gw-validation true"),", otherwise the action can be accessed publicly without any restrictions on the non api url. ")))}m.isMDXComponent=!0}}]);
//# sourceMappingURL=component---src-pages-guides-using-creating-rest-apis-md-21be999018aac2d73724.js.map