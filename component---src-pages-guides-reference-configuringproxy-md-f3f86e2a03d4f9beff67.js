"use strict";(self.webpackChunkadobe_io_runtime=self.webpackChunkadobe_io_runtime||[]).push([[7368],{87066:function(e,t,n){n.r(t),n.d(t,{_frontmatter:function(){return p},default:function(){return d}});var a=n(87462),r=n(63366),o=(n(15007),n(64983)),i=n(91515),m=["components"],p={},s={_frontmatter:p},l=i.Z;function d(e){var t=e.components,n=(0,r.Z)(e,m);return(0,o.mdx)(l,(0,a.Z)({},s,n,{components:t,mdxType:"MDXLayout"}),(0,o.mdx)("h2",{id:"configuring-a-secure-proxy"},"Configuring a Secure Proxy"),(0,o.mdx)("p",null,"Runtime does not expose egress IPs due to security reasons. If a customer needs a way to secure the communication with their downstream services using IP whitelisting, they can use a proxy in between their backend service and I/O Runtime."),(0,o.mdx)("p",null,"This can be done by the addition of a proxy component (in this example, an AWS EC2 instance running nginx). The proxy component will have a fixed IP address, therefore enabling the use of an IP allowlist to secure your backend service. The communication between I/O Runtime and the proxy component will be secured via mutual TLS (mTLS) communication. "),(0,o.mdx)("p",null,(0,o.mdx)("span",{parentName:"p",className:"gatsby-resp-image-wrapper",style:{position:"relative",display:"block",marginLeft:"auto",marginRight:"auto",maxWidth:"1140px"}},"\n      ",(0,o.mdx)("span",{parentName:"span",className:"gatsby-resp-image-background-image",style:{paddingBottom:"19.375%",position:"relative",bottom:"0",left:"0",display:"block",transition:"opacity 0.5s 0.5s",pointerEvents:"none"}}),"\n  ",(0,o.mdx)("picture",{parentName:"span"},"\n          ",(0,o.mdx)("source",{parentName:"picture",srcSet:["/adobe-io-runtime/static/78ab0c5d6215322154a4bf8d92019fff/5530d/configure-proxy.webp 320w","/adobe-io-runtime/static/78ab0c5d6215322154a4bf8d92019fff/0c8fb/configure-proxy.webp 640w","/adobe-io-runtime/static/78ab0c5d6215322154a4bf8d92019fff/b2cd5/configure-proxy.webp 1140w"],sizes:"(max-width: 1140px) 100vw, 1140px",type:"image/webp"}),"\n          ",(0,o.mdx)("source",{parentName:"picture",srcSet:["/adobe-io-runtime/static/78ab0c5d6215322154a4bf8d92019fff/dd4a7/configure-proxy.png 320w","/adobe-io-runtime/static/78ab0c5d6215322154a4bf8d92019fff/0f09e/configure-proxy.png 640w","/adobe-io-runtime/static/78ab0c5d6215322154a4bf8d92019fff/dc896/configure-proxy.png 1140w"],sizes:"(max-width: 1140px) 100vw, 1140px",type:"image/png"}),"\n          ",(0,o.mdx)("img",{parentName:"picture",className:"gatsby-resp-image-image",src:"/adobe-io-runtime/static/78ab0c5d6215322154a4bf8d92019fff/dc896/configure-proxy.png",alt:"configure proxy",title:"configure proxy",loading:"lazy",style:{width:"100%",height:"100%",margin:"0",verticalAlign:"middle",position:"absolute",opacity:"0",transition:"opacity 0.5s",color:"inherit",boxShadow:"inset 0px 0px 0px 400px none",top:"0",left:"0"}}),"\n        "),"\n    ")),(0,o.mdx)("p",null,"The following steps outline how to:"),(0,o.mdx)("ul",null,(0,o.mdx)("li",{parentName:"ul"},"Configure the NGINX proxy component to support mutual TLS (mTLS)"),(0,o.mdx)("li",{parentName:"ul"},"Configure an AppBuilder action to use mTLS to securely communicate with the proxy component")),(0,o.mdx)("p",null,(0,o.mdx)("em",{parentName:"p"},(0,o.mdx)("strong",{parentName:"em"},"Prerequisite:")," An EC2 instance with NGINX installed. The ",(0,o.mdx)("a",{parentName:"em",href:"https://docs.nginx.com/nginx/deployment-guides/amazon-web-services/ec2-instances-for-nginx/"},"official NGINX documentation")," has more information.")),(0,o.mdx)("ol",null,(0,o.mdx)("li",{parentName:"ol"},(0,o.mdx)("p",{parentName:"li"},"Verify SSH connectivity to the EC2 instance. (screenshot of terminal/template cmd)"),(0,o.mdx)("pre",{parentName:"li"},(0,o.mdx)("code",{parentName:"pre"},"ssh -i <your-key.pem> ec2-user@<EC2-IPAddress>\n"))),(0,o.mdx)("li",{parentName:"ol"},(0,o.mdx)("p",{parentName:"li"},"Generate certificates needed for mTLS (link out to example-mtls project for generating secrets)"),(0,o.mdx)("ul",{parentName:"li"},(0,o.mdx)("li",{parentName:"ul"},"Generate ",(0,o.mdx)("strong",{parentName:"li"},"mtls_server.key/.crt"),(0,o.mdx)("pre",{parentName:"li"},(0,o.mdx)("code",{parentName:"pre"},"openssl req -x509 -nodes -days 3650 -newkey rsa:4096 -keyout mtls_server.key -out mtls_server.crt\n"))),(0,o.mdx)("li",{parentName:"ul"},"Generate ",(0,o.mdx)("strong",{parentName:"li"},"mtls_client.key/.crt"),(0,o.mdx)("pre",{parentName:"li"},(0,o.mdx)("code",{parentName:"pre"},"openssl req -x509 -nodes -days 3650 -newkey rsa:4096 -keyout mtls_client.key -out mtls_client.crt\n"))))),(0,o.mdx)("li",{parentName:"ol"},(0,o.mdx)("p",{parentName:"li"},"Use the referenced file ",(0,o.mdx)("inlineCode",{parentName:"p"},"mtls.conf.example")," and replace ",(0,o.mdx)("inlineCode",{parentName:"p"},"DESTINATION_HOST")," with the final destination you would like to proxy to. For example, if your target host is ",(0,o.mdx)("inlineCode",{parentName:"p"},"api.myhost.com")," you would search for the following line"),(0,o.mdx)("pre",{parentName:"li"},(0,o.mdx)("code",{parentName:"pre"},"proxy_pass https://DESTINATION_HOST\n")),(0,o.mdx)("p",{parentName:"li"},"and replace it such that it looks like "),(0,o.mdx)("pre",{parentName:"li"},(0,o.mdx)("code",{parentName:"pre"},"proxy_pass https://api.myhost.com\n")),(0,o.mdx)("p",{parentName:"li"},"Save the resulting file locally as ",(0,o.mdx)("inlineCode",{parentName:"p"},"mtls.conf")," (in the same folder as your certificates).")),(0,o.mdx)("li",{parentName:"ol"},(0,o.mdx)("p",{parentName:"li"},"Copy sample NGINX configuration to EC2 instance with updated placeholder details. (terminal screenshots for ",(0,o.mdx)("inlineCode",{parentName:"p"},"scp")," cmds)"),(0,o.mdx)("ol",{parentName:"li"},(0,o.mdx)("li",{parentName:"ol"},"First copy files to home folder",(0,o.mdx)("pre",{parentName:"li"},(0,o.mdx)("code",{parentName:"pre"},"scp -i <your-key.pem> mtls_server.key mtls_server.crt mtls_client.key mtls_client.crt mtls.conf ec2-user@<EC2-IPAddress>:~/\n"))),(0,o.mdx)("li",{parentName:"ol"},"Then move them into place (while connected via SSH to the ec2 instance)",(0,o.mdx)("pre",{parentName:"li"},(0,o.mdx)("code",{parentName:"pre"},"sudo mv ~/mtls* /etc/nginx/conf.d/\n"))))),(0,o.mdx)("li",{parentName:"ol"},(0,o.mdx)("p",{parentName:"li"},"Restart ",(0,o.mdx)("inlineCode",{parentName:"p"},"nginx"))),(0,o.mdx)("li",{parentName:"ol"},(0,o.mdx)("p",{parentName:"li"},"Verify you can connect via curl locally from the ec2 instance"),(0,o.mdx)("pre",{parentName:"li"},(0,o.mdx)("code",{parentName:"pre"},"$ curl -ki --cert /etc/nginx/conf.d/mtls_client.crt --key /etc/nginx/conf.d/mtls_client.key https://localhost/\n")),(0,o.mdx)("ul",{parentName:"li"},(0,o.mdx)("li",{parentName:"ul"},(0,o.mdx)("em",{parentName:"li"},"(Optional)")," ",(0,o.mdx)("a",{parentName:"li",href:"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/creating-an-ami-ebs.html"},"Create an AMI")," from your running AWS instance in order to preserve your changes."))),(0,o.mdx)("li",{parentName:"ol"},(0,o.mdx)("p",{parentName:"li"},"In your AppBuilder app, you will need to make changes to wire the mTLS client key and certificate"),(0,o.mdx)("ul",{parentName:"li"},(0,o.mdx)("li",{parentName:"ul"},(0,o.mdx)("strong",{parentName:"li"},(0,o.mdx)("inlineCode",{parentName:"strong"},".env"),":")," Add the following lines with paths to your mtls client certificate files.",(0,o.mdx)("pre",{parentName:"li"},(0,o.mdx)("code",{parentName:"pre"},"## Support mTLS\n__AIO_MTLS_CERT=(cat /path/to/mtls_client.crt)\n__AIO_MTLS_KEY=(cat /path/to/mtls_client.key)\n"))),(0,o.mdx)("li",{parentName:"ul"},(0,o.mdx)("strong",{parentName:"li"},(0,o.mdx)("inlineCode",{parentName:"strong"},"app.config.yaml"),":")," Add the following default parameters pointing to the environment variables.",(0,o.mdx)("pre",{parentName:"li"},(0,o.mdx)("code",{parentName:"pre"},"inputs:\n    __AIO_MTLS_CERT: $__AIO_MTLS_CERT\n    __AIO_MTLS_KEY: $__AIO_MTLS_KEY\n"))))),(0,o.mdx)("li",{parentName:"ol"},(0,o.mdx)("p",{parentName:"li"},"In your action code, you can reference these environment variables when making an HTTP request to the proxy component (replace the ",(0,o.mdx)("inlineCode",{parentName:"p"},"PROXY_ENDPOINT")," with your AWS EC2 hostname/IP)"),(0,o.mdx)("pre",{parentName:"li"},(0,o.mdx)("code",{parentName:"pre"},"// configure the client side of mTLS\nconst options = {\n    cert: params.__AIO_MTLS_CERT,\n    key:  params.__AIO_MTLS_KEY,\n    rejectUnauthorized: false, // in test, if you're working with self-signed certificates\n    keepAlive: false, // switch to true if you're making a lot of calls from this client\n};\n\nconst sslConfiguredAgent = new https.Agent(options);\n\ntry {\n    // Replace the `PROXY_ENDPOINT` with your AWS EC2 hostname/IP\n    const url = \"https://PROXY_ENDPOINT/path/to/resource?param=value\"\n\n    console.log(`Making call to: [${url}]`);\n    // make the request just as you would normally ...\n    const response = await fetch(url, {\n    agent: sslConfiguredAgent, // ... but add the agent we initialised\n    });\n\n    const responseBody = await response.text();\n\n    // handle the response as you would see fit\n    console.log(responseBody);\n    return { statusCode: 200, body: { resp: responseBody }};\n} catch (error) {\n    // return the error\n    console.log(error);\n    return { statusCode: 418, body: { error: error }};\n}\n"))),(0,o.mdx)("li",{parentName:"ol"},(0,o.mdx)("p",{parentName:"li"},"Deploy your application to I/O Runtime via ",(0,o.mdx)("inlineCode",{parentName:"p"},"aio app deploy")," and test out the setup by invoking your action."))))}d.isMDXComponent=!0}}]);
//# sourceMappingURL=component---src-pages-guides-reference-configuringproxy-md-f3f86e2a03d4f9beff67.js.map