"use strict";(self.webpackChunkadobe_io_runtime=self.webpackChunkadobe_io_runtime||[]).push([[5939],{5084:function(e,a,t){t.r(a),t.d(a,{_frontmatter:function(){return s},default:function(){return p}});var n=t(87462),o=t(63366),i=(t(15007),t(64983)),r=t(91515),l=["components"],s={},m={_frontmatter:s},d=r.Z;function p(e){var a=e.components,t=(0,o.Z)(e,l);return(0,i.mdx)(d,(0,n.Z)({},m,t,{components:a,mdxType:"MDXLayout"}),(0,i.mdx)("h1",{id:"creating-actions"},"Creating Actions"),(0,i.mdx)("p",null,"For your code to execute as an ",(0,i.mdx)("em",{parentName:"p"},"action")," on Adobe I/O Runtime, your code has to comply with two rules:"),(0,i.mdx)("ul",null,(0,i.mdx)("li",{parentName:"ul"},"You either call your function ",(0,i.mdx)("em",{parentName:"li"},"main")," or you export the entry point as ",(0,i.mdx)("em",{parentName:"li"},"main"),". This is the function that will be executed when it is invoked."),(0,i.mdx)("li",{parentName:"ul"},"Your function accepts valid JSON objects as input and produces valid JSON objects as output, if needed")),(0,i.mdx)("p",null,"You have to configure ",(0,i.mdx)("strong",{parentName:"p"},"aio CLI")," on your machine to create and invoke actions. Refer to the ",(0,i.mdx)("a",{parentName:"p",href:"../tools/cli_install.md"},"aio CLI")," page for how to install and configure it. "),(0,i.mdx)("p",null,"Let","’","s assume you have this function available on your machine:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-javascript"},"// this is saved in a file named first-function.js\nfunction main(params) {\n    var nm = params.name || 'stranger';\n    return {payload: 'Hello ' + nm};\n}\n\nexports.main = main;\n")),(0,i.mdx)("p",null,"You can create an action called ",(0,i.mdx)("em",{parentName:"p"},"test")," using this command:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"aio rt:action:create test first-function.js\n")),(0,i.mdx)("p",null,"You can update an action at any time using the following command:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"aio rt:action:update test first-function.js\n")),(0,i.mdx)("p",null,"If you don","’","t need an action anymore, you can delete it:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"aio rt:action:delete test\n")),(0,i.mdx)("p",null,"If you want to save an action that is deployed to your machine, then you can use this command:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"aio rt:action:get test --save \n")),(0,i.mdx)("p",null,"Listing all the available actions in your current namespace is as simple as running this command:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"aio rt:action:list\n")),(0,i.mdx)("h2",{id:"invoking-actions"},"Invoking actions"),(0,i.mdx)("p",null,"Now, that you have an action, you can call it using the following command (in this example the action name is ",(0,i.mdx)("em",{parentName:"p"},"test"),"):"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"aio rt:action:invoke test --result\n")),(0,i.mdx)("p",null,"Note the flag ",(0,i.mdx)("em",{parentName:"p"},"--result")," used in the command. This flag outputs the result of the invocation. Without it, instead of seeing the result of the invocation, you","’","d get the activation ID. To get the result, you","’","d use this ID to retrieve the result like this:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"aio rt:activation:get <activation ID>\n")),(0,i.mdx)("p",null,"When you invoke an action, as in the example above, the invocation is not blocking (it is async). If you want to execute it in a blocking style and, as a result, get the activation record instead of just getting an activation ID, you have to add the ",(0,i.mdx)("em",{parentName:"p"},"--blocking")," flag to the command:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"aio rt:action:invoke test --blocking\n")),(0,i.mdx)("h2",{id:"working-with-parameters"},"Working with parameters"),(0,i.mdx)("p",null,"Actions can receive parameters when are being executed. First, any parameters you sent to the action will be available through the ",(0,i.mdx)("em",{parentName:"p"},"params")," variable. If you send two parameters called ",(0,i.mdx)("em",{parentName:"p"},"first-name")," and ",(0,i.mdx)("em",{parentName:"p"},"last-name"),", they will be available as ",(0,i.mdx)("em",{parentName:"p"},"params.first-name")," and ",(0,i.mdx)("em",{parentName:"p"},"params.last-name"),"."),(0,i.mdx)("p",null,"Second, let","’","s see how you can invoke the action with parameters. Our function sample from above uses a parameter called ",(0,i.mdx)("em",{parentName:"p"},"name"),". This is how you can set the parameter when invoking the action:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},'aio rt:action:invoke test --param name "John Doe" --result\n')),(0,i.mdx)("h2",{id:"setting-default-parameters"},"Setting default parameters"),(0,i.mdx)("p",null,"Sometimes you want to bind the same parameter values for all invocations or you just want to set default values. In either case, you have two different options: setting params at the package level (so all actions in that package can inherit them) or at action level."),(0,i.mdx)("h3",{id:"default-params-and-encryption"},"Default params and encryption"),(0,i.mdx)("p",null,"Before we dive deeper in how to set and use default params, let’s discuss the security aspect first. Many developers use the default params as a mechanism to provision actions with the secrets/passwords needed to authenticate against some other systems (databases, services, APIs)."),(0,i.mdx)("p",null,"In order to support this use case, all default params are automatically encrypted. They are decrypted just before the action code is executed. Thus, the only time you have access to the decrypted value is while executing the action code."),(0,i.mdx)("p",null,"If you run the CLI command for getting an action or package, you’d get a listing for the names of the default params while the values will be listed as a hash instead of the actual value."),(0,i.mdx)("h3",{id:"default-parameters-set-on-action"},"Default parameters set on action"),(0,i.mdx)("p",null,"Let","’",'s assume that you want the default value of your parameter to be "Runtime". You can set this value when creating the action, or if the action already exists, updating the action. In both cases you add the *--param" flag:'),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},'// creation time\naio rt:action:create test first-function.js --param name "Runtime"\n\n// update\naio rt:action:update test first-function.js --param name "Runtime"\n')),(0,i.mdx)("p",null,"Now, you can run the action without any parameters, and it will use the default one you","’","ve set. If you set a parameter when invoking, this will overwrite the default one."),(0,i.mdx)("h3",{id:"default-parameters-set-on-package"},"Default parameters set on package"),(0,i.mdx)("p",null,"When you create an action, it is always created in a package. If you don","’","t specify a package, the ",(0,i.mdx)("em",{parentName:"p"},"default")," package is used. Similar to how you set default parameters at the action level, you can specify default parameters at the package level."),(0,i.mdx)("p",null,"The difference is that the params set at the package level will be used for all the actions you create in that package."),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},'// creation time\naio rt:package:create my-package --param name "Runtime"\n\n// update\naio rt:package:update my-package --param name "Runtime"\n')),(0,i.mdx)("p",null,"At this point, you might ask yourself what is the precedence when setting parameters at the package level, action level, and invocation time. The winner is parameters set at invocation time, followed by parameters set at action level, and the last is parameters set at package level."),(0,i.mdx)("h3",{id:"default-parameters-with-parameter-file"},"Default parameters with parameter file"),(0,i.mdx)("p",null,"A neat way for setting default params is using a dedicated file for storing their values, and then using this file to set those values as default parameter values."),(0,i.mdx)("p",null,"This is especially useful when you are dealing with multiple parameter values for things like configuring API access keys, endpoints, and so on."),(0,i.mdx)("p",null,"Coming back to our sample function that expects one parameter, ",(0,i.mdx)("em",{parentName:"p"},"name"),", you","’","d create a JSON file to store that value:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-json"},'// filename is my-params.json\n{\n    "name": "Runtime"\n}\n')),(0,i.mdx)("p",null,"Then, you use the ",(0,i.mdx)("em",{parentName:"p"},"--param-file")," flag when creating actions, creating packages, or invoking actions."),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"// update action\naio rt:action:update test first-function.js --param-file my-params.json\n\n// invoke action\naio rt:action:invoke test --param-file my-params.json\n")),(0,i.mdx)("h3",{id:"final-parameters"},"Final Parameters"),(0,i.mdx)("p",null,"Sometimes, an application needs to ensure that the default parameters are final (or immutable), and a calling client can","’","t override them. You can achieve this by adding the ",(0,i.mdx)("inlineCode",{parentName:"p"},"final")," annotation - ",(0,i.mdx)("inlineCode",{parentName:"p"},"-a final true"),":"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},'aio rt:action:update test first-function.js --web true --param name "Runtime" -a final true\n')),(0,i.mdx)("p",null,"This mechanism works for all type of actions including web actions."),(0,i.mdx)("h2",{id:"invoking-web-actions"},"Invoking web actions"),(0,i.mdx)("p",null,"So far, we","’","ve been invoking actions only from the CLI. While this might be good for trying out your actions, as you design actions for production systems, you might need to be able to invoke actions via HTTP REST calls. This would enable you to invoke the actions from your web application. "),(0,i.mdx)("p",null,"You create a web action by adding the ",(0,i.mdx)("em",{parentName:"p"},"--web")," flag to the ",(0,i.mdx)("inlineCode",{parentName:"p"},"aio")," action command:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"// creation time\naio rt:action:create test first-function.js --web true\n\n// update\naio rt:action:update test first-function.js --web true\n")),(0,i.mdx)("p",null,"Notice the ",(0,i.mdx)("em",{parentName:"p"},"true")," value used in the command. If you set that value to ",(0,i.mdx)("em",{parentName:"p"},"false"),", then you disable a web action."),(0,i.mdx)("p",null,"To call the action as a web action, you need to know the full path to the action. You can find the path by adding the ",(0,i.mdx)("em",{parentName:"p"},"--url")," flag to the action command:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"aio rt:action:get test --url\n")),(0,i.mdx)("p",null,"This will give you something like:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"ok: got action test\nhttps://adobeioruntime.net/api/v1/web/[your namespace]/default/test\n")),(0,i.mdx)("p",null,"In the URL above, the ",(0,i.mdx)("inlineCode",{parentName:"p"},"default")," in the path stands for the ",(0,i.mdx)("inlineCode",{parentName:"p"},"default")," package: if you don","’","t create your actions explicitly in a package, then they get under the ",(0,i.mdx)("inlineCode",{parentName:"p"},"default")," package."),(0,i.mdx)("p",null,"You can invoke the action like this:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"curl -L https://adobeioruntime.net/api/v1/web/[your namespace]/default/test -X GET\n")),(0,i.mdx)("p",null,"or"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"curl https://[your namespace].adobeioruntime.net/api/v1/web/default/test -X GET\n")),(0,i.mdx)("p",null,(0,i.mdx)("strong",{parentName:"p"},"Note")," the change in the URL here in comparison to what the ",(0,i.mdx)("inlineCode",{parentName:"p"},"aio")," returns. This is due some additional protections Runtime provides to segregate namespaces from each other when invoking web actions. The ",(0,i.mdx)("inlineCode",{parentName:"p"},"aio")," generated link will still work but it will return a 308 redirect to your namespace's subdomain on Runtime. For a further discussion of this please see the ",(0,i.mdx)("a",{parentName:"p",href:"securing_web_actions.md"},"Securing Web Actions")," page."),(0,i.mdx)("h3",{id:"successful-response"},"Successful response"),(0,i.mdx)("p",null,"When creating actions to be used as web actions, you might want to send the response that follows the HTTP response structure (status code, headers, body). For example, our sample function could be rewritten:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-javascript"},"function main(params) {\n    var nm = params.name || 'stranger';\n    return {\n        statusCode: 200,\n        body: {\n            payload: 'Hello ' + nm\n        }\n    }\n}\n\nexports.main = main;\n")),(0,i.mdx)("p",null,"You can also set cookies or cache control headers, perform a HTTP redirect, and so forth."),(0,i.mdx)("h3",{id:"unsuccessful-response"},"Unsuccessful response"),(0,i.mdx)("p",null,"On failed web action invocations, the error code and message should be wrapped in an ",(0,i.mdx)("inlineCode",{parentName:"p"},"error")," object, as this would allow the system to interpret the response as an ",(0,i.mdx)("inlineCode",{parentName:"p"},"applicationError"),". "),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-javascript"},'function main(params) {\n    try {\n        throw new Error("Boom!")\n    } catch (err) {\n        return {\n            error: {\n                statusCode: 500,\n                body: {\n                    payload: `Something went wrong: ${err}`\n                }\n            }\n        }\n    }\n}\n\nexports.main = main;\n')),(0,i.mdx)("h3",{id:"dealing-with-errors-in-general"},"Dealing with errors in general"),(0,i.mdx)("p",null,"It is extremely important to handle errors in your action code. It is actually impossible to recover from an unhandled async error in Node.js. Please refer to the Node.js documentation related to ",(0,i.mdx)("a",{parentName:"p",href:"https://nodejs.org/api/process.html#event-uncaughtexception"},"uncaughtExceptions"),"."),(0,i.mdx)("p",null,"In the event of an unhandled async errors, the action will be terminated and the container running that action will be destroyed. This means that all in flight activations will be failed and, the next invocation of the action will incur the overhead of creating a new container."),(0,i.mdx)("p",null,"The following examples will show incorrect and correct handling of async errors:"),(0,i.mdx)("h4",{id:"incorrect-handling-of-async-errors"},"Incorrect handling of async errors"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-javascript"},'function doSomethingAsync() {\n    return new Promise((resolve, reject) => {\n        try {\n            setTimeout(() => {\n                new Error("Something went wrong");\n            }, 1000);\n        } catch (err) {\n            reject(err);\n        }\n    });\n}\n')),(0,i.mdx)("p",null,"This code will fail to handle the error and the action will be terminated; here the error is generated not while the executor is running, but later. So the try catch block will not be able to catch the error. "),(0,i.mdx)("h4",{id:"correct-handling-of-async-errors"},"Correct handling of async errors"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-javascript"},'function doSomethingAsync() {\n    return new Promise((resolve, reject) => {\n        setTimeout(() => {\n            reject(new Error("Something went wrong"));\n        }, 1000);\n    });\n}\n')),(0,i.mdx)("p",null,"This code will execute correctly and the error will be handled.     "),(0,i.mdx)("p",null,"In general when an asynchronous operation is performed, there is a chance that something could go wrong, such as a network error, a database connection issue, or an unexpected input.\nIf an error occurs but is not handled, the node process will be terminated. Therefore, it is important to always handle errors inside the callback function passed to setTimeout or any other async function to ensure the reliability and stability of the program."),(0,i.mdx)("h3",{id:"http-context"},"HTTP context"),(0,i.mdx)("p",null,"When executing an action as a web action, the ",(0,i.mdx)("inlineCode",{parentName:"p"},"params")," object is decorated with additional information:"),(0,i.mdx)("table",null,(0,i.mdx)("thead",{parentName:"table"},(0,i.mdx)("tr",{parentName:"thead"},(0,i.mdx)("th",{parentName:"tr",align:null},"Method"),(0,i.mdx)("th",{parentName:"tr",align:null},"Description"))),(0,i.mdx)("tbody",{parentName:"table"},(0,i.mdx)("tr",{parentName:"tbody"},(0,i.mdx)("td",{parentName:"tr",align:null},(0,i.mdx)("inlineCode",{parentName:"td"},"__ow_method")),(0,i.mdx)("td",{parentName:"tr",align:null},"the HTTP method of the request")),(0,i.mdx)("tr",{parentName:"tbody"},(0,i.mdx)("td",{parentName:"tr",align:null},(0,i.mdx)("inlineCode",{parentName:"td"},"__ow_headers")),(0,i.mdx)("td",{parentName:"tr",align:null},"the request headers")),(0,i.mdx)("tr",{parentName:"tbody"},(0,i.mdx)("td",{parentName:"tr",align:null},(0,i.mdx)("inlineCode",{parentName:"td"},"__ow_path")),(0,i.mdx)("td",{parentName:"tr",align:null},"the unmatched path of the request (matching stops after consuming the action extension)")),(0,i.mdx)("tr",{parentName:"tbody"},(0,i.mdx)("td",{parentName:"tr",align:null},(0,i.mdx)("inlineCode",{parentName:"td"},"__ow_body")),(0,i.mdx)("td",{parentName:"tr",align:null},"the request body entity, as a base64-encoded string when its content is binary or JSON object/array, or as a plain string otherwise")),(0,i.mdx)("tr",{parentName:"tbody"},(0,i.mdx)("td",{parentName:"tr",align:null},(0,i.mdx)("inlineCode",{parentName:"td"},"__ow_query")),(0,i.mdx)("td",{parentName:"tr",align:null},"the query parameters from the request as an unparsed string")))),(0,i.mdx)("p",null,"By default, web actions are accessible to anyone who knows the URL. If you want to secure the access, you can find more info on the ",(0,i.mdx)("a",{parentName:"p",href:"securing_web_actions.md"},"Securing Web Actions")," page."),(0,i.mdx)("h2",{id:"deploying-zip-actions"},"Deploying ZIP actions"),(0,i.mdx)("p",null,"So far, we","’","ve been creating actions from a single source file. What if you need to create an action from multiple files and you also need some ",(0,i.mdx)("strong",{parentName:"p"},"npm")," modules? The answer is deploying a ZIP action. "),(0,i.mdx)("p",null,"You need to do three things to deploy a ZIP action: create a manifest file, create the package.json file, and configure/use ",(0,i.mdx)("inlineCode",{parentName:"p"},"wskdeploy")," instead of ",(0,i.mdx)("inlineCode",{parentName:"p"},"aio")," for the actual deploy."),(0,i.mdx)("h3",{id:"wskdeploy"},"wskdeploy"),(0,i.mdx)("p",null," If you need to install ",(0,i.mdx)("inlineCode",{parentName:"p"},"wskdeploy"),", check the page ",(0,i.mdx)("a",{parentName:"p",href:"../tools/wskdeploy_install.md"},"Setting up the wskdeploy CLI"),"."),(0,i.mdx)("h3",{id:"packagejson-file"},"Package.json file"),(0,i.mdx)("p",null,"You use the package.json file to specify the dependencies. If you don","’","t have one already, in the same folder where your function files are, run ",(0,i.mdx)("inlineCode",{parentName:"p"},"npm init -y"),"."),(0,i.mdx)("p",null,"Make sure you have the npm dependencies you need for your functions declared in the package file."),(0,i.mdx)("h3",{id:"wskdeploy-manifest-file"},"wskdeploy manifest file"),(0,i.mdx)("p",null,"The last step is creating the manifest file that will be used by wskdeploy to create your action. In the parent folder of the folder where you have your function files and npm modules, create a file ",(0,i.mdx)("inlineCode",{parentName:"p"},"manifest.yaml"),". (For more information on YAML format, see the ",(0,i.mdx)("a",{parentName:"p",href:"http://yaml.org/refcard.html"},"YAML reference card"),".)"),(0,i.mdx)("p",null,"This is the folder structure:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"--/actions\n--/actions/node_modules/\n--/actions/index.js\n--/actions/package.json\n--manifest.yaml\n")),(0,i.mdx)("p",null,"Here is an example manifest.yaml:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"packages:\n    # this is the package name\n    test:\n        actions:\n            # name of the action\n            test-zip:\n                # source for the action; in this case it is a folder\n                function: actions\n                runtime: nodejs:10\n                # publish the action as a web action\n                web:  yes\n")),(0,i.mdx)("blockquote",null,(0,i.mdx)("p",{parentName:"blockquote"},(0,i.mdx)("strong",{parentName:"p"},"Note:")," If your action require dependencies (such as other node modules or JavaScript files), you need to place the action code in a ",(0,i.mdx)("inlineCode",{parentName:"p"},"index.js")," file and in the ",(0,i.mdx)("inlineCode",{parentName:"p"},"manifest.yaml")," file, the ",(0,i.mdx)("inlineCode",{parentName:"p"},"function")," value should point to the folder where the action is stored instead of the action file. You can see this in action in the example above.")),(0,i.mdx)("p",null,"Now you are ready to deploy by running the ",(0,i.mdx)("inlineCode",{parentName:"p"},"wskdeploy")," command from the same folder where ",(0,i.mdx)("inlineCode",{parentName:"p"},"manifest.yaml")," is:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"wskdeploy\n")),(0,i.mdx)("p",null,"This should deploy an action called ",(0,i.mdx)("em",{parentName:"p"},"test-zip")," under a package called ",(0,i.mdx)("em",{parentName:"p"},"test"),". You can invoke it like this:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"aio rt:action:invoke test/test-zip --result\n")),(0,i.mdx)("p",null,"If you want to remove this action, you run ",(0,i.mdx)("inlineCode",{parentName:"p"},"wskdeploy")," with the ",(0,i.mdx)("em",{parentName:"p"},"undeploy")," flag:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"wskdeploy undeploy\n")),(0,i.mdx)("p",null,"There are other useful flows ",(0,i.mdx)("inlineCode",{parentName:"p"},"wskdeploy")," supports. Please check the ",(0,i.mdx)("a",{parentName:"p",href:"https://github.com/apache/openwhisk-wskdeploy"},"official documentation")," if you want to find more."),(0,i.mdx)("blockquote",null,(0,i.mdx)("p",{parentName:"blockquote"},(0,i.mdx)("strong",{parentName:"p"},"Note:")," There is another way of deploying a ZIP action using the aio command. You miss the manifest.yaml file flexibility with this mode; you can","’","t define multiple actions/packages at the same time. The ZIP file has to have in the root the package.json file.",(0,i.mdx)("br",{parentName:"p"}),"\n",(0,i.mdx)("inlineCode",{parentName:"p"},"aio rt:action:create my-action --kind nodejs:20 zip-file.zip"))))}p.isMDXComponent=!0}}]);
//# sourceMappingURL=component---src-pages-guides-using-creating-actions-md-33568c5fdf421acf97d7.js.map